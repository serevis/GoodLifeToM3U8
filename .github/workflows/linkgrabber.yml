name: LinkGrabber

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */3 * * *" # every 3 hours (GitHub cron is UTC)

# Prevent overlapping runs of this workflow
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (ffmpeg, yt-dlp) with retries
        shell: bash
        run: |
          set -Eeuo pipefail
          for i in {1..3}; do
            if sudo apt-get update && sudo apt-get install -y ffmpeg; then break; fi
            echo "apt failed (attempt $i), retrying in 10s..."; sleep 10
          done
          python -m pip install --upgrade pip
          # Pin to a broad, future-safe range but avoid sudden breaking changes
          pip install "yt-dlp>=2024.04.09,<2026.0"

      - name: Resolve HLS and write files
        shell: bash
        run: |
          set -Eeuo pipefail
          python - <<'PY'
          import subprocess, json, sys, shlex, time
          from pathlib import Path
          from datetime import datetime, timedelta, timezone
          from xml.sax.saxutils import escape

          NAME = "The Good Life Radio â€“ Relax / Deep House / Chillout (24/7)"
          CID  = "TheGoodLifeRadio.yt"
          GROUP= "Deep House"
          URL  = "https://www.youtube.com/watch?v=36YnV9STBqc"

          def run(cmd):
            return subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT, text=True).strip()

          def try_yt(cmd):
            # Add some yt-dlp stability flags
            base = f"yt-dlp --no-warnings --no-progress --retry-sleep 2 --retries 10 --fragment-retries 10 --concurrent-fragments 5 {cmd}"
            return run(base)

          def resolve(u: str) -> str:
            # Try a few formats, prefer HLS
            fmts = [
              "best[protocol^=m3u8][vcodec!=none]+bestaudio/best[protocol^=m3u8]/best",
              "bv*+ba/b[protocol^=m3u8]/b",
              "best"
            ]
            for fmt in fmts:
              try:
                out = try_yt(f"-g -f {shlex.quote(fmt)} {shlex.quote(u)}")
                lines = [ln.strip() for ln in out.splitlines() if ln.strip()]
                for ln in lines:
                  if ".m3u8" in ln:
                    return ln
                if lines:
                  return lines[-1]
              except subprocess.CalledProcessError:
                pass
            # JSON probe fallback
            try:
              data = json.loads(try_yt(f"-J {shlex.quote(u)}"))
              fmts = data.get("formats") or []
              hls = [f for f in fmts if (f.get("protocol") or "").startswith("m3u8") or "m3u8" in (f.get("ext") or "")]
              hls.sort(key=lambda f: (0 if f.get("vcodec") not in (None,"none") else 1, f.get("tbr") or 0), reverse=True)
              for f in hls:
                if f.get("url"): return f["url"]
                if f.get("manifest_url"): return f["manifest_url"]
            except Exception as e:
              print("JSON probe failed:", e, file=sys.stderr)
            return ""

          # Light retry/backoff around resolution
          hls = ""
          for attempt in range(1, 5):
            hls = resolve(URL)
            if hls and ".m3u8" in hls:
              break
            sleep = 5 * attempt
            print(f"Resolve attempt {attempt} failed; retrying in {sleep}s...", file=sys.stderr)
            time.sleep(sleep)
          if not hls or ".m3u8" not in hls:
            print("Failed to resolve a playable HLS URL", file=sys.stderr)
            sys.exit(2)

          # Write M3U (escape attributes just in case)
          m3u = (
            "#EXTM3U\n"
            f'#EXTINF:-1 tvg-id="{escape(CID)}" tvg-name="{escape(NAME)}" group-title="{escape(GROUP)}",{NAME}\n'
            f"{hls}\n"
          )
          Path("streams.m3u8").write_text(m3u, encoding="utf-8")

          # Write EPG for the next 24h
          now = datetime.now(timezone.utc); stop = now + timedelta(hours=24)
          fmt = lambda dt: dt.strftime("%Y%m%d%H%M%S +0000")
          epg = (
            '<?xml version="1.0" encoding="UTF-8"?>\n'
            '<tv generator-info-name="GoodLifeToM3U8">\n'
            f'  <channel id="{escape(CID)}">\n'
            f'    <display-name>{escape(NAME)}</display-name>\n'
            f'  </channel>\n'
            f'  <programme start="{fmt(now)}" stop="{fmt(stop)}" channel="{escape(CID)}">\n'
            f'    <title>{escape(NAME)} (Live)</title>\n'
            f'    <desc>Auto-generated EPG slot for a continuous live stream.</desc>\n'
            f'  </programme>\n'
            '</tv>\n'
          )
          Path("epg.xml").write_text(epg, encoding="utf-8")

          print("Generated streams.m3u8 and epg.xml")
          PY

      - name: Validate M3U and EPG
        shell: bash
        run: |
          set -Eeuo pipefail
          head -n 5 streams.m3u8
          grep -q '^#EXTM3U' streams.m3u8
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          xmllint --noout epg.xml

      - name: Commit and push if changed (only on default branch)
        if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        shell: bash
        run: |
          set -Eeuo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add streams.m3u8 epg.xml || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update playlists"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linkgrabber-outputs
          path: |
            streams.m3u8
            epg.xml
