name: LinkGrabber

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */3 * * *"   # every 3 hours

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yt-dlp + ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          pip install --upgrade yt-dlp

      - name: Resolve HLS and write files
        run: |
          python - <<'PY'
          import subprocess, json, sys, shlex
          from pathlib import Path
          from datetime import datetime, timedelta, timezone

          NAME = "The Good Life Radio â€“ Relax / Deep House / Chillout (24/7)"
          CID  = "TheGoodLifeRadio.yt"
          GROUP= "Deep House"
          URL  = "https://www.youtube.com/watch?v=36YnV9STBqc"

          def run(cmd):
            return subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT, text=True).strip()

          def resolve(u: str) -> str:
            for fmt in ["best[protocol^=m3u8]","bv*+ba/b[protocol^=m3u8]/b","best"]:
              try:
                out = run(f"yt-dlp --no-warnings -g -f {shlex.quote(fmt)} {shlex.quote(u)}")
                lines = [ln.strip() for ln in out.splitlines() if ln.strip()]
                for ln in lines:
                  if ".m3u8" in ln:
                    return ln
                if lines:
                  return lines[-1]
              except subprocess.CalledProcessError:
                pass
            try:
              data = json.loads(run(f"yt-dlp -J {shlex.quote(u)}"))
              fmts = data.get("formats") or []
              hls = [f for f in fmts if (f.get("protocol") or "").startswith("m3u8") or "m3u8" in (f.get("ext") or "")]
              hls.sort(key=lambda f: (0 if f.get("vcodec") not in (None,"none") else 1, f.get("tbr") or 0), reverse=True)
              for f in hls:
                if f.get("url"): return f["url"]
                if f.get("manifest_url"): return f["manifest_url"]
            except Exception as e:
              print("JSON probe failed:", e, file=sys.stderr)
            return ""

          hls = resolve(URL)
          if not hls or ".m3u8" not in hls:
            print("Failed to resolve a playable HLS URL", file=sys.stderr)
            sys.exit(2)

          Path("streams.m3u8").write_text(
            "#EXTM3U\n"
            f'#EXTINF:-1 tvg-id="{CID}" tvg-name="{NAME}" group-title="{GROUP}",{NAME}\n'
            f"{hls}\n", encoding="utf-8"
          )

          now = datetime.now(timezone.utc); stop = now + timedelta(hours=24)
          fmt = lambda dt: dt.strftime("%Y%m%d%H%M%S +0000")
          Path("epg.xml").write_text(
            '<?xml version="1.0" encoding="UTF-8"?>\n'
            '<tv generator-info-name="GoodLifeToM3U8">\n'
            f'  <channel id="{CID}">\n'
            f'    <display-name>{NAME}</display-name>\n'
            f'  </channel>\n'
            f'  <programme start="{fmt(now)}" stop="{fmt(stop)}" channel="{CID}">\n'
            f'    <title>{NAME} (Live)</title>\n'
            f'    <desc>Auto-generated EPG slot for a continuous live stream.</desc>\n'
            f'  </programme>\n'
            '</tv>\n', encoding="utf-8"
          )

          print("Generated streams.m3u8 and epg.xml")
          PY

      - name: Validate and show M3U
        run: |
          head -n 5 streams.m3u8
          grep -q '^#EXTM3U' streams.m3u8

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add streams.m3u8 epg.xml || true
          git diff --cached --quiet || git commit -m "Auto-update playlists"
          git push
